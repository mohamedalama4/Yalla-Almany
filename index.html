<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Almany - Pro Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #2c3e50; 
            --german-gold: #d4af37; 
            --white: rgba(255, 255, 255, 0.9);
            --success: #27ae60;
            --danger: #c0392b;
            --muted-blue: #546e7a;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            margin: 0; padding: 0; min-height: 100vh;
            background: url('https://www.shutterstock.com/image-photo/baroque-artistic-image-portrait-adolf-260nw-2622706447.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #2c3e50;
        }

        .container { 
            width: 92%; max-width: 900px; margin: 20px auto; padding: 20px; border-radius: 20px;
        }

        @media (max-width: 600px) {
            .container { padding: 15px; margin: 10px auto; }
            .inner-brand h2 { font-size: 1.8rem; }
            nav span { padding: 10px 8px; font-size: 0.75rem; }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        nav { 
            background: rgba(44, 62, 80, 0.98); 
            display: flex; justify-content: center; flex-wrap: wrap; 
            position: sticky; top: 0; z-index: 1000;
        }
        nav span { cursor: pointer; color: #ecf0f1; padding: 15px; font-weight: 700; transition: 0.3s; }
        nav span.active { color: var(--german-gold); border-bottom: 3px solid var(--german-gold); }

        input, textarea { 
            padding: 12px; border: none; border-radius: 10px; width: 100%; box-sizing: border-box;
            background: white; margin-bottom: 10px; font-family: inherit; font-weight: 700; border: 1px solid #ddd;
        }
        button { 
            padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; 
            cursor: pointer; font-weight: 900; width: 100%; transition: 0.2s;
        }

        .words-container-area { background: rgba(255, 255, 255, 0.4); padding: 10px; border-radius: 15px; }
        .words-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        .words-table th { background: var(--muted-blue); color: white; padding: 10px; border-radius: 5px; text-align: center; }
        .words-table td { background: rgba(255,255,255,0.8); padding: 12px; color: #444; }

        .plan-card { 
            background: rgba(255,255,255,0.85); padding: 20px; border-radius: 15px; 
            margin-bottom: 15px; border-left: 6px solid var(--german-gold);
            white-space: pre-wrap; line-height: 1.6;
        }

        .admin-section { 
            margin-top: 20px; padding: 20px; background: #fdfdfd; 
            border-radius: 15px; border: 2px solid var(--german-gold); 
        }
        .admin-item-row { 
            display: flex; justify-content: space-between; align-items: center;
            background: #eee; padding: 10px 15px; margin-bottom: 5px; border-radius: 8px; font-size: 0.9rem; font-weight: bold;
        }
        .btn-del-small { background: var(--danger); width: auto; padding: 5px 12px; font-size: 0.75rem; }
        
        .hidden { display: none; }
        .inner-brand { text-align: center; margin-bottom: 20px; }
        .inner-brand b { color: var(--german-gold); }

        /* ÿ≥ÿ™ÿßŸäŸÑ ÿµŸàÿ±ÿ© ÿßŸÑÿ±ÿßŸÜŸÉ */
        .rank-avatar {
            width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--german-gold); 
            object-fit: cover; margin-right: 10px; background: #eee;
        }
        .rank-user-info { display: flex; align-items: center; }
    </style>
</head>
<body>

<nav id="main-nav" class="hidden">
    <span id="nav-home" onclick="showPage('home')">Home</span>
    <span id="nav-progress" onclick="showPage('progress')">Lessons</span>
    <span id="nav-plane" onclick="showPage('plane')">Study Plan</span>
    <span id="nav-words" onclick="showPage('words')">Words</span>
    <span id="nav-add-words" onclick="showPage('add-words')">+ Add Words</span>
    <span id="nav-profile" onclick="showPage('profile')">Profile</span>
</nav>

<div class="container glass-effect">
    <div id="page-login">
        <div class="inner-brand"><h2>Yalla <b>Almany</b></h2></div>
        <input type="text" id="login-user" placeholder="Username">
        <input type="password" id="login-pass" placeholder="Password">
        <button onclick="handleAuth()">Login</button>
        <div style="text-align:center; margin-top:15px;"><small onclick="document.getElementById('admin-login-box').classList.toggle('hidden')" style="cursor:pointer">Admin Access</small></div>
        <div id="admin-login-box" class="hidden">
            <input type="password" id="adm-pass" placeholder="Admin Key" style="margin-top:10px;">
            <button onclick="checkAdminLogin()" style="background:#111;">Admin Login</button>
        </div>
    </div>

    <div id="page-home" class="hidden">
        <div class="inner-brand"><h2>Rank<b>ings</b> üèÜ</h2></div>
        <div id="leaderboard-list"></div>

        <div id="admin-box" class="hidden admin-section">
            <h3 style="margin-top:0; color: var(--german-gold);">Management Panel ‚öôÔ∏è</h3>
            <div style="margin-bottom:20px;">
                <strong>üë• Manage Students:</strong>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="adm-std-name" placeholder="Name">
                    <input type="text" id="adm-std-pass" placeholder="Password">
                </div>
                <button onclick="updateStudent()" style="background:var(--success)">Add Student</button>
                <div id="admin-users-list" style="margin-top:10px"></div>
            </div>
            <hr>
            <div style="margin-bottom:20px; margin-top:15px;">
                <strong>üìö Manage Curriculum:</strong>
                <input type="text" id="adm-lesson-title" placeholder="New Lesson Title (or URL)" style="margin-top:5px;">
                <button onclick="addLesson()" style="background:var(--primary)">Add New Lesson</button>
                <div id="admin-lessons-list" style="margin-top:10px"></div>
            </div>
            <hr>
            <div style="margin-top:15px;">
                <strong>üéØ Manage Study Plan:</strong>
                <textarea id="plan-input" placeholder="Enter study steps..."></textarea>
                <button onclick="addPlan()" style="background:var(--german-gold)">Post New Plan</button>
                <div id="admin-plans-list" style="margin-top:10px"></div>
            </div>
        </div>
    </div>

    <div id="page-plane" class="hidden">
        <div class="inner-brand"><h2>Learning <b>Path</b> üéØ</h2></div>
        <div id="plan-display-container"></div>
    </div>

    <div id="page-progress" class="hidden">
        <div class="inner-brand"><h2>Curri<b>culum</b> üìñ</h2></div>
        <div id="lessons-list"></div>
    </div>

    <div id="page-words" class="hidden">
        <div class="inner-brand"><h2>Muted <b>Dictionary</b> üìö</h2></div>
        <div class="words-container-area">
            <div style="overflow-x: auto;">
                <table class="words-table">
                    <thead><tr><th>German</th><th>Meaning</th><th>By</th><th>Action</th></tr></thead>
                    <tbody id="words-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="page-add-words" class="hidden">
        <div class="inner-brand"><h2>Contribute ‚úçÔ∏è</h2></div>
        <div class="admin-section">
            <input type="text" id="word-de" placeholder="German Word">
            <input type="text" id="word-ar" placeholder="Meaning (Arabic)">
            <button onclick="addNewWord()" style="background:var(--german-gold)">Add to Dictionary</button>
        </div>
    </div>

    <div id="page-profile" class="hidden">
        <div style="text-align:center;">
            <img id="profile-img" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--german-gold); object-fit:cover; margin-bottom: 10px;">
            <h3 id="profile-name-display" style="margin-bottom: 20px;"></h3>
            
            <div class="admin-section" style="background: rgba(255,255,255,0.6); border: 1px solid #ddd; max-width: 400px; margin: 0 auto;">
                <p style="font-weight: bold; margin-bottom: 15px;">Account Settings</p>
                <label style="background:var(--primary); color:white; padding:10px 15px; border-radius:8px; cursor:pointer; display: block; margin-bottom: 15px; font-size: 0.9rem;">
                    Change Photo <input type="file" id="avatar-input" accept="image/*" onchange="uploadAvatar()" style="display:none">
                </label>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">
                <div id="password-change-area">
                    <input type="password" id="new-password" placeholder="Enter New Password" style="margin-bottom: 10px;">
                    <button onclick="updatePassword()" style="background:var(--success); font-size: 0.85rem; padding: 10px;">Update Password</button>
                </div>
            </div>
            <button onclick="location.reload()" style="margin-top:40px; background:var(--danger); width: 150px;">Logout</button>
        </div>
    </div>
</div>

<script>
    const DB_URL = "https://germany-b892a-default-rtdb.europe-west1.firebasedatabase.app/courseData";
    let currentUser = "";
    let isAdmin = false;
    let dbData = { lessons: {}, users: {}, userProfiles: {}, plans: {}, words: {} };

    async function sync() {
        try {
            const res = await fetch(`${DB_URL}.json`);
            const data = await res.json();
            if (data) { dbData = data; refreshUI(); }
        } catch(e) { console.error("Network Error"); }
    }

    async function save(path, val) {
        await fetch(`${DB_URL}/${path}.json`, { 
            method: val === null ? 'DELETE' : 'PUT', 
            body: val === null ? null : JSON.stringify(val) 
        });
        sync();
    }

    function refreshUI() {
        if (!currentUser) return;
        renderLeaderboard();
        renderLessons();
        renderWordsTable();
        renderPlans();
        if(isAdmin) renderAdminSpecifics();
        updateProfileUI();
    }

    function handleAuth() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        if (dbData.users && dbData.users[u] === p) { currentUser = u; startApp(); } 
        else alert("Wrong Credentials");
    }

    function checkAdminLogin() {
        if (document.getElementById('adm-pass').value === (dbData.adminPassword || "123")) {
            isAdmin = true; currentUser = "Admin";
            document.getElementById('admin-box').classList.remove('hidden');
            startApp();
        } else alert("Invalid Key");
    }

    function startApp() {
        document.getElementById('page-login').classList.add('hidden');
        document.getElementById('main-nav').classList.remove('hidden');
        document.getElementById('profile-name-display').innerText = currentUser;
        showPage('home');
        sync();
    }

    function showPage(page) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.querySelectorAll('nav span').forEach(s => s.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.remove('hidden');
        document.getElementById(`nav-${page}`).classList.add('active');
    }

    async function updatePassword() {
        const newPass = document.getElementById('new-password').value.trim();
        if (!newPass) { alert("Please enter a new password"); return; }
        if (newPass.length < 4) { alert("Password too short!"); return; }
        if (confirm("Change password for " + currentUser + "?")) {
            if (isAdmin) alert("Admin password must be changed via Database.");
            else {
                await save(`users/${currentUser}`, newPass);
                alert("Password updated!");
                document.getElementById('new-password').value = "";
            }
        }
    }

    function renderAdminSpecifics() {
        let uHtml = "";
        Object.keys(dbData.users || {}).forEach(name => {
            uHtml += `<div class="admin-item-row"><span>${name}</span><button class="btn-del-small" onclick="deleteItem('users/${name}')">Remove</button></div>`;
        });
        document.getElementById('admin-users-list').innerHTML = uHtml;

        let lHtml = "";
        Object.entries(dbData.lessons || {}).forEach(([id, l]) => {
            lHtml += `<div class="admin-item-row"><span>${l.title}</span><button class="btn-del-small" onclick="deleteItem('lessons/${id}')">Delete</button></div>`;
        });
        document.getElementById('admin-lessons-list').innerHTML = lHtml;
    }

    function addLesson() {
        const t = document.getElementById('adm-lesson-title').value.trim();
        if(t) { save(`lessons/L${Date.now()}`, { title: t, completedBy: "" }); document.getElementById('adm-lesson-title').value = ""; }
    }

    function addPlan() {
        const txt = document.getElementById('plan-input').value.trim();
        if(txt) { save(`plans/P${Date.now()}`, { text: txt, time: Date.now() }); document.getElementById('plan-input').value = ""; }
    }

    function addNewWord() {
        const de = document.getElementById('word-de').value.trim();
        const ar = document.getElementById('word-ar').value.trim();
        if(de && ar) {
            save(`words/W${Date.now()}`, { de, ar, user: currentUser, time: Date.now() });
            document.getElementById('word-de').value = ""; 
            document.getElementById('word-ar').value = "";
        }
    }

    function toggleLesson(id) {
        if(isAdmin) return;
        let cBy = (dbData.lessons[id].completedBy || "").split(',').filter(u => u);
        cBy.includes(currentUser) ? cBy = cBy.filter(u => u !== currentUser) : cBy.push(currentUser);
        save(`lessons/${id}/completedBy`, cBy.join(','));
    }

    function deleteItem(path) { if(confirm("Confirm deletion?")) save(path, null); }

    function updateStudent() {
        const n = document.getElementById('adm-std-name').value.trim();
        const p = document.getElementById('adm-std-pass').value.trim();
        if(n && p) { save(`users/${n}`, p); document.getElementById('adm-std-name').value=""; document.getElementById('adm-std-pass').value=""; }
    }

    // ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ÿØŸäÿØ: ÿ•ÿ∏Ÿáÿßÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµ ŸÅŸä ÿßŸÑÿ±ÿßŸÜŸÉ
    function renderLeaderboard() {
        const board = document.getElementById('leaderboard-list');
        const lessons = dbData.lessons || {};
        const total = Object.keys(lessons).length || 1;
        let html = "";
        
        Object.keys(dbData.users || {}).forEach(user => {
            let count = 0;
            Object.values(lessons).forEach(l => { if((l.completedBy||"").includes(user)) count++; });
            let pc = Math.round((count/total)*100);
            
            // ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà Ÿàÿ∂ÿπ ÿµŸàÿ±ÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            const userImg = (dbData.userProfiles && dbData.userProfiles[user]) ? dbData.userProfiles[user].photo : "https://via.placeholder.com/50";

            html += `<div style="background:rgba(255,255,255,0.7); margin-bottom:8px; padding:10px; border-radius:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">
                    <div class="rank-user-info">
                        <img src="${userImg}" class="rank-avatar">
                        <span>${user}</span>
                    </div>
                    <span>${pc} %</span>
                </div>
                <div style="background:#ddd; height:6px; border-radius:10px;"><div style="width:${pc}%; background:var(--german-gold); height:100%; border-radius:10px;"></div></div>
            </div>`;
        });
        board.innerHTML = html;
    }

    function renderLessons() {
        const list = document.getElementById('lessons-list');
        let html = "";
        Object.entries(dbData.lessons || {}).forEach(([id, l]) => {
            const done = (l.completedBy || "").includes(currentUser);
            let displayTitle = l.title;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            if (urlRegex.test(l.title)) {
                displayTitle = l.title.replace(urlRegex, function(url) {
                    return `<a href="${url}" target="_blank" onclick="event.stopPropagation()" style="color: var(--primary); text-decoration: underline; font-weight: bold;">(ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØÿ±ÿ≥ üîó)</a>`;
                });
            }
            html += `<div class="plan-card" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center" onclick="toggleLesson('${id}')">
                <span style="flex-grow:1; margin-right:10px;">${displayTitle}</span>
                <span style="font-size:1.5rem">${done?'‚úî':'‚óã'}</span>
            </div>`;
        });
        list.innerHTML = html || "<p style='text-align:center'>No lessons yet.</p>";
    }

    function renderWordsTable() {
        const tbody = document.getElementById('words-table-body');
        const words = Object.entries(dbData.words || {}).sort((a,b) => b[1].time - a[1].time);
        let html = "";
        words.forEach(([id, w]) => {
            const canDel = isAdmin || w.user === currentUser;
            html += `<tr>
                <td style="direction: ltr; text-align: left; font-weight: 700;">${w.de}</td>
                <td style="direction: rtl; text-align: right; font-weight: 400;">${w.ar}</td>
                <td style="font-size:0.7rem; color:#666; text-align: center;">${w.user}</td>
                <td style="text-align: center;">${canDel ? `<button class="btn-del-small" onclick="deleteItem('words/${id}')">√ó</button>` : ''}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function renderPlans() {
        const container = document.getElementById('plan-display-container');
        let html = "";
        const plans = Object.entries(dbData.plans || {}).sort((a,b) => b[1].time - a[1].time);
        plans.forEach(([id, p]) => { html += `<div class="plan-card">${p.text}</div>`; });
        container.innerHTML = html || "<p style='text-align:center'>No plans yet.</p>";
    }

    function uploadAvatar() {
        const file = document.getElementById('avatar-input').files[0];
        const reader = new FileReader();
        reader.onloadend = () => save(`userProfiles/${currentUser}/photo`, reader.result);
        if(file) reader.readAsDataURL(file);
    }

    function updateProfileUI() {
        const img = (dbData.userProfiles && dbData.userProfiles[currentUser]) ? dbData.userProfiles[currentUser].photo : "https://via.placeholder.com/150";
        document.getElementById('profile-img').src = img;
    }

    sync();
</script>
</body>
</html>
